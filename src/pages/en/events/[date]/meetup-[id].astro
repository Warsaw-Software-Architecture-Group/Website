---
import Layout from '../../../../layouts/Layout.astro';
import Navigation from '../../../../components/Navigation.astro';
import Footer from '../../../../components/Footer.astro';
import { events, getEventByDateAndId, generateEventUrl, type Event } from '../../../../data/events';
import { getTranslations } from '../../../../i18n/translations';

export async function getStaticPaths() {
  return events.map(event => {
    const eventDate = new Date(event.date).toISOString().split('T')[0];
    return {
      params: {
        date: eventDate,
        id: event.meetupId.toString()
      },
      props: { event }
    };
  });
}

const { date, id } = Astro.params;
const { event } = Astro.props as { event: Event };

if (!event) {
  return Astro.redirect('/en/404');
}

const lang = 'en';
const t = getTranslations(lang);

const formatTime = (time: string) => {
  return new Date(`2000-01-01T${time}`).toLocaleTimeString('en-US', {
    hour: 'numeric',
    minute: '2-digit',
    hour12: false
  });
};

const getLocationName = (locationName: string, language: string) => {
  if (locationName === 'Siedziba Circle K') {
    return language === 'en' ? 'Circle K Headquarters' : 'Siedziba Circle K';
  }
  return locationName;
};
---

<Layout title={`${event.title} - WSAG Event`} description={event.description} type="article" lang={lang}>
  <Navigation lang={lang} isMainPage={false} />

  <!-- Event Schema.org JSON-LD -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Event",
    "name": event.title,
    "description": event.description,
    "startDate": `${event.date}T${event.time}`,
    "endDate": `${event.date}T${event.endTime || '21:00'}`,
    "eventStatus": event.status === 'upcoming' ? "https://schema.org/EventScheduled" : "https://schema.org/EventPostponed",
    "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
    "location": {
      "@type": "Place",
      "name": event.location.name,
      "address": {
        "@type": "PostalAddress",
        "streetAddress": event.location.address,
        "addressLocality": "Warsaw",
        "addressCountry": "PL"
      }
    },
    "organizer": {
      "@type": "Organization",
      "name": "Warsaw Software Architecture Group",
      "url": Astro.site || "https://wsag.org"
    },
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "PLN",
      "availability": "https://schema.org/InStock",
      "url": event.registrationUrl
    },
    "performer": event.presentations ? event.presentations.map(p => {
      const speaker = event.speakers.find(s => s.name.toLowerCase().replace(/\s+/g, '-') === p.speakerId);
      return speaker ? {
        "@type": "Person",
        "name": speaker.name,
        "jobTitle": speaker.role,
        "worksFor": {
          "@type": "Organization",
          "name": speaker.company
        }
      } : null;
    }).filter(p => p !== null) : []
  })} />

  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pt-28 pb-16">
        <div class="text-center">
          <div class="inline-flex items-center px-3 py-1 rounded-full bg-white/20 text-sm font-medium mb-4">
            {event.status === 'upcoming' ? (
              <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 2a8 8 0 100 16 8 8 0 000-16zM9 12H7v-2h2V7h2v3h2v2h-2v1H9v-1z"/>
              </svg>
            ) : (
              <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
            )}
            {event.status === 'upcoming' ? 'Upcoming Event' : 'Past Event'} - Meetup #{event.meetupId}
          </div>

          <h1 class="text-4xl md:text-5xl font-bold mb-4">{event.title}</h1>
          <p class="text-xl opacity-90 max-w-2xl mx-auto">{event.description}</p>

          <div class="flex flex-wrap justify-center gap-4 mt-8">
            <div class="flex items-center bg-white/10 px-4 py-2 rounded-lg">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              {event.date}
            </div>
            <div class="flex items-center bg-white/10 px-4 py-2 rounded-lg">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              {formatTime(event.time)} - {formatTime(event.endTime)}
            </div>
            <div class="flex items-center bg-white/10 px-4 py-2 rounded-lg">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
              {getLocationName(event.location.name, lang)}
            </div>
          </div>

          {event.status === 'upcoming' && event.registrationUrl && (
            <div class="mt-8">
              <a href={event.registrationUrl} class="inline-block px-8 py-4 bg-white text-blue-600 rounded-lg hover:bg-gray-50 transition-colors duration-200 font-bold text-lg shadow-lg">
                Register Now
              </a>
            </div>
          )}
        </div>
      </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <div class="grid lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-8">
          <!-- Description -->
          <div class="bg-white rounded-xl shadow-md p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">{t.eventDetails.aboutThisEvent}</h2>
            <div class="prose prose-blue max-w-none">
              {event.longDescription.split('\n\n').map(paragraph => (
                <p class="text-gray-600 mb-4">{paragraph}</p>
              ))}
            </div>
          </div>

          <!-- Presentations -->
          {event.presentations && event.presentations.length > 0 && (
          <div class="bg-white rounded-xl shadow-md p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">{t.eventDetails.presentations}</h2>
            <div class="space-y-8">
              {event.presentations.map(presentation => {
                const speaker = event.speakers.find(s => s.id === presentation.speakerId);
                const agendaItem = event.agenda.find(a => a.presentationId === presentation.id);
                const startTime = agendaItem?.time || '';
                return (
                  <div class="border border-gray-200 rounded-lg p-6">
                    {/* Presentation Header */}
                    <div class="flex items-start justify-between mb-4">
                      <div class="flex-1">
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">{presentation.title}</h3>

                        {/* Tags */}
                        {presentation.tags.length > 0 && (
                          <div class="flex flex-wrap gap-2 mb-4">
                            {presentation.tags.map(tag => (
                              <span class="px-2 py-1 bg-blue-50 text-blue-700 text-xs rounded-full">
                                #{tag}
                              </span>
                            ))}
                          </div>
                        )}

                        {/* Speaker Info */}
                        <div class="flex items-center space-x-3">
                          <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-bold">
                              {speaker ? speaker.name.split(' ').map(n => n[0]).join('') : '??'}
                            </span>
                          </div>
                          <div>
                            <p class="font-semibold text-gray-900">{speaker?.name}</p>
                            {speaker?.role && speaker?.company && (
                              <p class="text-sm text-blue-600">{speaker.role} @ {speaker.company}</p>
                            )}
                          </div>
                        </div>
                      </div>
                      {startTime && (
                        <div class="flex flex-col items-end space-y-2">
                          <span class="text-sm text-gray-500">{startTime}</span>
                        </div>
                      )}
                    </div>

                    {/* Presentation Description */}
                    {presentation.description && (
                      <div class="mb-4">
                        <p class="text-gray-600">{presentation.description}</p>
                      </div>
                    )}

                    {/* Speaker Description */}
                    {speaker && speaker.bio && (
                      <div class="pt-4 border-t border-gray-100">
                        <p class="text-gray-600 mb-3">{speaker.bio}</p>

                        {/* Social Links */}
                        <div class="flex space-x-3">
                          {speaker.linkedin && (
                            <a href={speaker.linkedin} class="text-gray-400 hover:text-blue-600 transition-colors" title="LinkedIn">
                              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                              </svg>
                            </a>
                          )}
                          {speaker.github && (
                            <a href={speaker.github} class="text-gray-400 hover:text-gray-900 transition-colors" title="GitHub">
                              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.30 3.297-1.30.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                              </svg>
                            </a>
                          )}
                          {speaker.twitter && (
                            <a href={speaker.twitter} class="text-gray-400 hover:text-blue-400 transition-colors" title="Twitter">
                              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                              </svg>
                            </a>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
          )}

          {/* Resources (for completed events) */}
          {event.status === 'completed' && event.resources && (
            <div class="bg-white rounded-xl shadow-md p-8">
              <h2 class="text-2xl font-bold text-gray-900 mb-6">{t.eventDetails.eventResources}</h2>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                {event.resources.slides && (
                  <a href={event.resources.slides} class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <svg class="w-8 h-8 text-blue-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                    <span class="text-sm font-medium text-gray-900">{t.eventDetails.slides}</span>
                  </a>
                )}
                {event.resources.video && (
                  <a href={event.resources.video} class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <svg class="w-8 h-8 text-red-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-sm font-medium text-gray-900">{t.eventDetails.video}</span>
                  </a>
                )}
                {event.resources.code && (
                  <a href={event.resources.code} class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <svg class="w-8 h-8 text-gray-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                    </svg>
                    <span class="text-sm font-medium text-gray-900">{t.eventDetails.code}</span>
                  </a>
                )}
                {event.resources.blog && (
                  <a href={event.resources.blog} class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <svg class="w-8 h-8 text-green-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                    <span class="text-sm font-medium text-gray-900">{t.eventDetails.blog}</span>
                  </a>
                )}
              </div>
            </div>
          )}
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          <!-- Event Details -->
          <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">{t.eventDetails.eventDetailsTitle}</h3>
            <div class="space-y-4">
              <div>
                <h4 class="font-medium text-gray-900 mb-1">{t.eventDetails.location}</h4>
                <p class="text-gray-600 text-sm">{getLocationName(event.location.name, lang)}</p>
                <p class="text-gray-600 text-sm">{event.location.address}</p>
                <p class="text-gray-600 text-sm">{event.location.city}</p>
              </div>

              <div>
                <h4 class="font-medium text-gray-900 mb-1">{t.eventDetails.accessibility}</h4>
                <p class="text-gray-600 text-sm">{event.location.accessibility}</p>
              </div>

              <div>
                <h4 class="font-medium text-gray-900 mb-1">{t.eventDetails.capacity}</h4>
                <p class="text-gray-600 text-sm">{t.eventDetails.upToAttendees.replace('{count}', event.maxAttendees)}</p>
              </div>
            </div>
          </div>

          <!-- Prerequisites -->
          {event.prerequisites && event.prerequisites.length > 0 && (
            <div class="bg-white rounded-xl shadow-md p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">{t.eventDetails.prerequisites}</h3>
              <ul class="space-y-2">
                {event.prerequisites.map(prerequisite => (
                  <li class="flex items-start text-sm">
                    <svg class="w-4 h-4 text-green-500 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="text-gray-600">{prerequisite}</span>
                  </li>
                ))}
              </ul>
            </div>
          )}

          <!-- Target Audience -->
          <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">{t.eventDetails.targetAudience}</h3>
            <div class="flex flex-wrap gap-2">
              {event.targetAudience.map(audience => (
                <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">
                  {audience}
                </span>
              ))}
            </div>
          </div>

          <!-- Tags -->
          <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">{t.eventDetails.topics}</h3>
            <div class="flex flex-wrap gap-2">
              {event.tags.map(tag => (
                <span class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full">
                  #{tag}
                </span>
              ))}
            </div>
          </div>
        </div>
      </div>

      <!-- Location Map - Full Width -->
      <div class="bg-white rounded-xl shadow-md p-8 mt-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">{t.eventDetails.location}</h2>
        <div class="space-y-6">
          <!-- Map -->
          <div class="w-full">
            <div class="h-80 bg-gray-100 rounded-lg overflow-hidden">
              <div id="event-map" class="w-full h-full"></div>
            </div>
          </div>

          <!-- Location Details -->
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <h3 class="text-lg font-semibold text-gray-900 mb-3">{getLocationName(event.location.name, lang)}</h3>
              <div class="flex items-start text-gray-600">
                <svg class="w-5 h-5 mr-2 mt-0.5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <div>
                  <div>{event.location.address}</div>
                  <div>{event.location.city}</div>
                </div>
              </div>
            </div>

            <div>
              <h4 class="text-lg font-semibold text-gray-900 mb-3">
                Venue Partner
              </h4>
              <a
                href="https://www.circlek.pl/"
                target="_blank"
                rel="noopener noreferrer"
                class="inline-block bg-white p-4 rounded-lg border border-gray-200 hover:border-blue-400 transition-colors duration-200"
              >
                <img
                  src="/images/circle-k-logo.png"
                  alt="Circle K Logo"
                  class="h-12 w-auto"
                />
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <div class="mt-12 flex justify-between items-center">
        <a href="/en/events" class="flex items-center text-blue-600 hover:text-blue-700 font-medium">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Back to All Events
        </a>

        <a href="/en" class="text-gray-600 hover:text-gray-900">
          Back to Home
        </a>
      </div>
    </div>
  </div>

  <Footer lang={lang} />
</Layout>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script define:vars={{ eventLocation: event.location }}>
  document.addEventListener('DOMContentLoaded', function() {
    // Geocode the address to get coordinates
    const address = `${eventLocation.address}, ${eventLocation.city}`;

    // Use a geocoding service to get coordinates
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
      .then(response => response.json())
      .then(data => {
        if (data && data.length > 0) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);

          // Initialize the map
          const map = L.map('event-map').setView([lat, lon], 16);

          // Add OpenStreetMap tiles
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(map);

          // Add a marker for the event location
          L.marker([lat, lon])
            .addTo(map)
            .bindPopup(`
              <div style="text-align: center;">
                <strong>${eventLocation.name}</strong><br/>
                ${eventLocation.address}<br/>
                ${eventLocation.city}
              </div>
            `)
            .openPopup();
        } else {
          // Fallback: show a default map centered on Warsaw
          const map = L.map('event-map').setView([52.2297, 21.0122], 13);

          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(map);
        }
      })
      .catch(error => {
        console.error('Error geocoding address:', error);
        // Fallback map
        const map = L.map('event-map').setView([52.2297, 21.0122], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
      });
  });
</script>

<style>
  html {
    scroll-behavior: smooth;
  }

  .leaflet-container {
    border-radius: 0.5rem;
  }
</style>
