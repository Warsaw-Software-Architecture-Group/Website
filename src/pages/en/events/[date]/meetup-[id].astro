---
import Layout from '../../../../layouts/Layout.astro';
import Navigation from '../../../../components/Navigation.astro';
import Footer from '../../../../components/Footer.astro';
import { events, getEventByDateAndId, generateEventUrl, getLocalizedText, toLocalDateString, type Event, type PresentationResource } from '../../../../data/events';
import { getTranslations } from '../../../../i18n/translations';

export async function getStaticPaths() {
  return events.map(event => {
    const eventDate = toLocalDateString(new Date(event.date));
    return {
      params: {
        date: eventDate,
        id: event.meetupId.toString()
      },
      props: { event }
    };
  });
}

const { date, id } = Astro.params;
const { event } = Astro.props as { event: Event };

if (!event) {
  return Astro.redirect('/en/404');
}

const lang = 'en';
const t = getTranslations(lang);

const formatTime = (time: string) => {
  return new Date(`2000-01-01T${time}`).toLocaleTimeString('en-US', {
    hour: 'numeric',
    minute: '2-digit',
    hour12: false
  });
};

const formatDate = (dateString: string, language: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString(language === 'pl' ? 'pl-PL' : 'en-US', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
};

const getLocationName = (locationName: string, language: string) => {
  if (locationName === 'Siedziba Circle K') {
    return language === 'en' ? 'Circle K Headquarters' : 'Siedziba Circle K';
  }
  return locationName;
};

// Generate Google Calendar URL
const generateGoogleCalendarUrl = (event: Event) => {
  const eventDate = new Date(event.date);
  const [startHour, startMinute] = event.time.split(':').map(Number);
  const [endHour, endMinute] = event.endTime.split(':').map(Number);

  const startDate = new Date(eventDate);
  startDate.setHours(startHour, startMinute, 0);

  const endDate = new Date(eventDate);
  endDate.setHours(endHour, endMinute, 0);

  const formatDateForGoogle = (date: Date) => {
    return date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
  };

  const params = new URLSearchParams({
    action: 'TEMPLATE',
    text: event.title,
    dates: `${formatDateForGoogle(startDate)}/${formatDateForGoogle(endDate)}`,
    details: getLocalizedText(event.description, lang) + (event.registrationUrl ? `\n\nRegistration: ${event.registrationUrl}` : ''),
    location: `${event.location.name}, ${event.location.address}, ${event.location.city}`,
    ctz: 'Europe/Warsaw'
  });

  return `https://calendar.google.com/calendar/render?${params.toString()}`;
};

const googleCalendarUrl = generateGoogleCalendarUrl(event);

const resourceColorClasses: Record<string, string> = {
  recording: 'bg-red-50 text-red-700 hover:bg-red-100',
  slides: 'bg-teal-50 text-teal-700 hover:bg-teal-100',
  template: 'bg-purple-50 text-purple-700 hover:bg-purple-100',
  book: 'bg-green-50 text-green-700 hover:bg-green-100',
  code: 'bg-gray-100 text-gray-700 hover:bg-gray-200',
  blog: 'bg-blue-50 text-blue-700 hover:bg-blue-100',
  other: 'bg-gray-100 text-gray-700 hover:bg-gray-200',
};
---

<Layout title={`${event.title} - WSAG Event`} description={getLocalizedText(event.description, lang)} type="article" lang={lang}>
  <Navigation lang={lang} isMainPage={false} />

  <!-- Event Schema.org JSON-LD -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Event",
    "name": event.title,
    "description": getLocalizedText(event.description, lang),
    "startDate": `${event.date}T${event.time}`,
    "endDate": `${event.date}T${event.endTime || '21:00'}`,
    "eventStatus": event.status === 'upcoming' ? "https://schema.org/EventScheduled" : "https://schema.org/EventPostponed",
    "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
    "location": {
      "@type": "Place",
      "name": event.location.name,
      "address": {
        "@type": "PostalAddress",
        "streetAddress": event.location.address,
        "addressLocality": "Warsaw",
        "addressCountry": "PL"
      }
    },
    "organizer": {
      "@type": "Organization",
      "name": "Warsaw Software Architecture Group",
      "url": Astro.site || "https://wsag.org"
    },
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "PLN",
      "availability": "https://schema.org/InStock",
      "url": event.registrationUrl
    },
    "performer": event.presentations ? event.presentations.map(p => {
      const speaker = event.speakers.find(s => s.name.toLowerCase().replace(/\s+/g, '-') === p.speakerId);
      return speaker ? {
        "@type": "Person",
        "name": speaker.name,
        "jobTitle": speaker.role,
        "worksFor": {
          "@type": "Organization",
          "name": speaker.company
        }
      } : null;
    }).filter(p => p !== null) : []
  })} />

  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-gradient-to-r from-[#29B7C0] to-[#1e959c] text-white">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pt-28 pb-16">
        <div class="text-center">
          <div class="inline-flex items-center px-3 py-1 rounded-full bg-white/20 text-sm font-medium mb-4">
            {event.status === 'upcoming' ? (
              <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 2a8 8 0 100 16 8 8 0 000-16zM9 12H7v-2h2V7h2v3h2v2h-2v1H9v-1z"/>
              </svg>
            ) : (
              <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
            )}
            {event.status === 'upcoming' ? 'Upcoming Event' : 'Past Event'} - Meetup #{event.meetupId}
          </div>

          <h1 class="text-4xl md:text-5xl font-bold mb-4">{event.title}</h1>
          <p class="text-xl opacity-90 max-w-2xl mx-auto">{getLocalizedText(event.description, lang)}</p>

          <div class="flex flex-wrap justify-center gap-4 mt-8">
            <div class="flex items-center bg-white/10 px-4 py-2 rounded-lg">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              {formatDate(event.date, lang)}
            </div>
            <div class="flex items-center bg-white/10 px-4 py-2 rounded-lg">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              {formatTime(event.time)} - {formatTime(event.endTime)}
            </div>
            <div class="flex items-center bg-white/10 px-4 py-2 rounded-lg">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
              {getLocationName(event.location.name, lang)}
            </div>
          </div>

          {event.status === 'upcoming' && (
            <div class="mt-8">
              <!-- Countdown Timer -->
              <div id="countdown" class="flex justify-center gap-4 mb-8">
                <div class="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-3 min-w-[80px] text-center">
                  <div id="countdown-days" class="text-3xl font-bold">--</div>
                  <div class="text-sm opacity-80">days</div>
                </div>
                <div class="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-3 min-w-[80px] text-center">
                  <div id="countdown-hours" class="text-3xl font-bold">--</div>
                  <div class="text-sm opacity-80">hours</div>
                </div>
                <div class="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-3 min-w-[80px] text-center">
                  <div id="countdown-minutes" class="text-3xl font-bold">--</div>
                  <div class="text-sm opacity-80">minutes</div>
                </div>
                <div class="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-3 min-w-[80px] text-center">
                  <div id="countdown-seconds" class="text-3xl font-bold">--</div>
                  <div class="text-sm opacity-80">seconds</div>
                </div>
              </div>

              <div class="flex flex-wrap justify-center gap-4">
                {event.registrationUrl && (
                  <a href={event.registrationUrl} class="inline-block px-8 py-4 bg-white text-[#29B7C0] rounded-lg hover:bg-gray-50 transition-colors duration-200 font-bold text-lg shadow-lg">
                    Register Now
                  </a>
                )}
                <a href={googleCalendarUrl} target="_blank" rel="noopener noreferrer" class="inline-flex items-center px-6 py-4 bg-white/20 text-white border border-white/30 rounded-lg hover:bg-white/30 transition-colors duration-200 font-medium">
                  <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/>
                  </svg>
                  Add to Calendar
                </a>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <div class="grid lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-8">
          <!-- Description -->
          <div class="bg-white rounded-xl shadow-md p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">{t.eventDetails.aboutThisEvent}</h2>
            <div class="prose prose-blue max-w-none">
              {getLocalizedText(event.longDescription, lang).split('\n\n').map(paragraph => (
                <p class="text-gray-600 mb-4">{paragraph}</p>
              ))}
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">{t.eventDetails.eventDetailsTitle}</h3>
            <div class="space-y-4">
              <div>
                <h4 class="font-medium text-gray-900 mb-1">{t.eventDetails.location}</h4>
                <p class="text-gray-600 text-sm">{getLocationName(event.location.name, lang)}</p>
                <p class="text-gray-600 text-sm">{event.location.address}</p>
                <p class="text-gray-600 text-sm">{event.location.city}</p>
                {event.location.directions && event.location.directions !== 'Details to be announced' && (
                  <p class="text-gray-600 text-sm font-medium">{event.location.directions}</p>
                )}
              </div>
              <div>
                <h4 class="font-medium text-gray-900 mb-1">{t.eventDetails.accessibility}</h4>
                <p class="text-gray-600 text-sm">{event.location.accessibility}</p>
              </div>
              <div>
                <h4 class="font-medium text-gray-900 mb-1">{t.eventDetails.capacity}</h4>
                <p class="text-gray-600 text-sm">{t.eventDetails.upToAttendees.replace('{count}', event.maxAttendees)}</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Agenda (full width) -->
      {event.agenda && event.agenda.length > 0 && (
      <div class="bg-white rounded-xl shadow-md p-8 mt-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-8">Agenda</h2>
          <div class="relative">
            <!-- Timeline line -->
            <div class="absolute left-[27px] top-2 bottom-2 w-px bg-gray-200"></div>

            <div class="space-y-0">
              {event.agenda.map((item) => {
                const isPresentation = item.type === 'presentation' || item.type === 'talk';
                const speaker = isPresentation && item.speakerIds?.[0]
                  ? event.speakers.find(s => s.id === item.speakerIds[0])
                  : null;
                const presentation = isPresentation && item.presentationId
                  ? event.presentations.find(p => p.id === item.presentationId)
                  : null;

                return (
                  <div class={`relative flex gap-5 ${isPresentation ? 'py-6' : 'py-4'}`}>
                    <!-- Timeline dot -->
                    <div class="flex-shrink-0 w-[55px] flex flex-col items-center z-10">
                      {isPresentation && !presentation?.cancelled ? (
                        <div class="w-3 h-3 rounded-full bg-[#29B7C0] ring-4 ring-[#29B7C0]/20 mt-1.5"></div>
                      ) : isPresentation && presentation?.cancelled ? (
                        <div class="w-3 h-3 rounded-full bg-red-400 ring-4 ring-red-100 mt-1.5"></div>
                      ) : (
                        <div class="w-2.5 h-2.5 rounded-full bg-gray-300 ring-4 ring-gray-100 mt-1.5"></div>
                      )}
                      <span class="text-xs font-semibold text-gray-400 mt-2">{item.time}</span>
                    </div>

                    <!-- Content -->
                    <div class={`flex-1 min-w-0 ${isPresentation && presentation?.cancelled ? 'bg-red-50/60 rounded-xl p-6 -my-1 border border-red-200/60 border-dashed' : isPresentation ? 'bg-gray-50 rounded-xl p-6 -my-1' : ''}`}>
                      {isPresentation ? (
                        <div class={presentation?.cancelled ? 'opacity-75' : ''}>
                          {presentation?.cancelled && (
                            <div class="flex items-center gap-2 mb-3">
                              <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                {lang === 'pl' ? 'OdwoÅ‚ana' : 'Cancelled'}
                              </span>
                              {presentation.cancellationNote && (
                                <span class="text-xs text-red-600/80">{getLocalizedText(presentation.cancellationNote, lang)}</span>
                              )}
                            </div>
                          )}
                          <div class="flex items-start gap-4">
                            {speaker?.photo && (
                              <img src={speaker.photo} alt={speaker.name} class={`w-14 h-14 rounded-xl object-cover flex-shrink-0 shadow-sm ${presentation?.cancelled ? 'grayscale opacity-60' : ''}`} />
                            )}
                            <div class="flex-1 min-w-0">
                              <h4 class={`text-lg font-semibold leading-snug ${presentation?.cancelled ? 'text-gray-400 line-through decoration-red-300/70 decoration-2' : 'text-gray-900'}`}>
                                {presentation ? getLocalizedText(presentation.title, lang) : item.title}
                              </h4>
                              {speaker && (
                                <p class={`text-sm mt-1 ${presentation?.cancelled ? 'text-gray-400' : 'text-gray-500'}`}>{speaker.name}</p>
                              )}
                              {presentation?.language && !presentation?.cancelled && (
                                <div class="flex items-center gap-3 mt-2">
                                  <span class="inline-flex items-center gap-1 text-xs text-gray-500 bg-white px-2 py-0.5 rounded-full">
                                    <span>{presentation.language === 'pl' ? 'ðŸ‡µðŸ‡±' : 'ðŸ‡¬ðŸ‡§'}</span>
                                    <span>{presentation.language === 'pl' ? 'Polish' : 'English'}</span>
                                  </span>
                                </div>
                              )}
                            </div>
                          </div>
                          {presentation?.description && !presentation?.cancelled && (
                            <div class="text-sm text-gray-600 mt-4 leading-relaxed" set:html={getLocalizedText(presentation.description, lang)} />
                          )}
                          {event.status === 'completed' && presentation?.resources && presentation.resources.length > 0 && (
                            <div class="mt-4 pt-4 border-t border-gray-200">
                              <h5 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">{t.eventDetails.materials}</h5>
                              <div class="flex flex-wrap gap-2">
                                {presentation.resources.map((resource) => {
                                  const resourceTitle = typeof resource.title === 'string' ? resource.title : resource.title[lang] || resource.title.en;
                                  const colorClasses = resourceColorClasses[resource.type] || resourceColorClasses.other;
                                  return (
                                    <a
                                      href={resource.url}
                                      target={resource.url.startsWith('/') ? '_self' : '_blank'}
                                      rel={resource.url.startsWith('/') ? undefined : 'noopener noreferrer'}
                                      class={`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${colorClasses}`}
                                    >
                                      {resource.type === 'recording' && (
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                        </svg>
                                      )}
                                      {resource.type === 'slides' && (
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                        </svg>
                                      )}
                                      {resource.type === 'template' && (
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
                                        </svg>
                                      )}
                                      {resource.type === 'book' && (
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                        </svg>
                                      )}
                                      {resource.type === 'code' && (
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                                        </svg>
                                      )}
                                      {resource.type === 'blog' && (
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 110-2 1 1 0 010 2z" />
                                        </svg>
                                      )}
                                      {resourceTitle}
                                    </a>
                                  );
                                })}
                              </div>
                            </div>
                          )}
                        </div>
                      ) : (
                        <div>
                          <h4 class="font-medium text-gray-500">{item.title}</h4>
                          {item.description && (
                            <p class="text-sm text-gray-400 mt-0.5">{item.description}</p>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
        )}

      <!-- Location Map - Full Width -->
      <div class="bg-white rounded-xl shadow-md p-8 mt-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">{t.eventDetails.location}</h2>
        <div class="space-y-6">
          <!-- Map -->
          <div class="w-full">
            <div class="h-80 bg-gray-100 rounded-lg overflow-hidden">
              <div id="event-map" class="w-full h-full"></div>
            </div>
          </div>

          <!-- Location Details -->
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <h3 class="text-lg font-semibold text-gray-900 mb-3">{getLocationName(event.location.name, lang)}</h3>
              <div class="flex items-start text-gray-600">
                <svg class="w-5 h-5 mr-2 mt-0.5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <div>
                  <div>{event.location.address}</div>
                  <div>{event.location.city}</div>
                  {event.location.directions && event.location.directions !== 'Details to be announced' && (
                    <div class="mt-1 font-medium text-gray-700">{event.location.directions}</div>
                  )}
                </div>
              </div>
            </div>

            {event.venuePartner && (
            <div>
              <h4 class="text-lg font-semibold text-gray-900 mb-3">
                Venue Partner
              </h4>
              <a
                href={event.venuePartner.url}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-block bg-white p-4 rounded-lg border border-gray-200 hover:border-[#29B7C0] transition-colors duration-200"
              >
                <img
                  src={event.venuePartner.logo}
                  alt={event.venuePartner.name}
                  class="h-12 w-auto"
                />
              </a>
            </div>
            )}
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <div class="mt-12 flex justify-between items-center">
        <a href="/en/events" class="flex items-center text-[#29B7C0] hover:text-[#1e959c] font-medium">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Back to All Events
        </a>

        <a href="/en" class="text-gray-600 hover:text-gray-900">
          Back to Home
        </a>
      </div>
    </div>
  </div>

  <Footer lang={lang} />
</Layout>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script define:vars={{ eventLocation: event.location }}>
  document.addEventListener('DOMContentLoaded', function() {
    // Geocode the address to get coordinates
    const address = `${eventLocation.address}, ${eventLocation.city}`;

    // Use a geocoding service to get coordinates
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
      .then(response => response.json())
      .then(data => {
        if (data && data.length > 0) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);

          // Initialize the map
          const map = L.map('event-map').setView([lat, lon], 16);

          // Add OpenStreetMap tiles
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(map);

          // Add a marker for the event location
          L.marker([lat, lon])
            .addTo(map)
            .bindPopup(`
              <div style="text-align: center;">
                <strong>${eventLocation.name}</strong><br/>
                ${eventLocation.address}<br/>
                ${eventLocation.city}
              </div>
            `)
            .openPopup();
        } else {
          // Fallback: show a default map centered on Warsaw
          const map = L.map('event-map').setView([52.2297, 21.0122], 13);

          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(map);
        }
      })
      .catch(error => {
        console.error('Error geocoding address:', error);
        // Fallback map
        const map = L.map('event-map').setView([52.2297, 21.0122], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
      });
  });
</script>

<script define:vars={{ eventDate: event.date, eventTime: event.time }}>
  document.addEventListener('DOMContentLoaded', function() {
    const countdownElement = document.getElementById('countdown');
    if (!countdownElement) return;

    const targetDate = new Date(eventDate);
    const [hours, minutes] = eventTime.split(':').map(Number);
    targetDate.setHours(hours, minutes, 0, 0);

    function updateCountdown() {
      const now = new Date();
      const diff = targetDate - now;

      if (diff <= 0) {
        countdownElement.innerHTML = '<div class="text-xl font-bold">Event is happening now!</div>';
        return;
      }

      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hoursLeft = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutesLeft = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const secondsLeft = Math.floor((diff % (1000 * 60)) / 1000);

      document.getElementById('countdown-days').textContent = days.toString().padStart(2, '0');
      document.getElementById('countdown-hours').textContent = hoursLeft.toString().padStart(2, '0');
      document.getElementById('countdown-minutes').textContent = minutesLeft.toString().padStart(2, '0');
      document.getElementById('countdown-seconds').textContent = secondsLeft.toString().padStart(2, '0');
    }

    updateCountdown();
    setInterval(updateCountdown, 1000);
  });
</script>

<style>
  html {
    scroll-behavior: smooth;
  }

  .leaflet-container {
    border-radius: 0.5rem;
  }
</style>
